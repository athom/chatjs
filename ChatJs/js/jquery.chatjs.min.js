(function($){var defaults={className:"autosizejs",id:"autosizejs",append:"",callback:false,resizeDelay:10,placeholder:true},copy='<textarea tabindex="-1" style="position:absolute; top:-999px; left:0; right:auto; bottom:auto; border:0; padding: 0; -moz-box-sizing:content-box; -webkit-box-sizing:content-box; box-sizing:content-box; word-wrap:break-word; height:0 !important; min-height:0 !important; overflow:hidden; transition:none; -webkit-transition:none; -moz-transition:none;"/>',typographyStyles=["fontFamily","fontSize","fontWeight","fontStyle","letterSpacing","textTransform","wordSpacing","textIndent"],mirrored,mirror=$(copy).data("autosize",true)[0];mirror.style.lineHeight="99px";if($(mirror).css("lineHeight")==="99px"){typographyStyles.push("lineHeight")}mirror.style.lineHeight="";$.fn.autosize=function(options){if(!this.length){return this}options=$.extend({},defaults,options||{});if(mirror.parentNode!==document.body){$(document.body).append(mirror)}return this.each(function(){var ta=this,$ta=$(ta),maxHeight,minHeight,boxOffset=0,callback=$.isFunction(options.callback),originalStyles={height:ta.style.height,overflow:ta.style.overflow,overflowY:ta.style.overflowY,wordWrap:ta.style.wordWrap,resize:ta.style.resize},timeout,width=$ta.width();if($ta.data("autosize")){return}$ta.data("autosize",true);if($ta.css("box-sizing")==="border-box"||$ta.css("-moz-box-sizing")==="border-box"||$ta.css("-webkit-box-sizing")==="border-box"){boxOffset=$ta.outerHeight()-$ta.height()}minHeight=Math.max(parseInt($ta.css("minHeight"),10)-boxOffset||0,$ta.height());$ta.css({overflow:"hidden",overflowY:"hidden",wordWrap:"break-word",resize:$ta.css("resize")==="none"||$ta.css("resize")==="vertical"?"none":"horizontal"});function setWidth(){var width;var style=window.getComputedStyle?window.getComputedStyle(ta,null):false;if(style){width=ta.getBoundingClientRect().width;if(width===0){width=parseInt(style.width,10)}$.each(["paddingLeft","paddingRight","borderLeftWidth","borderRightWidth"],function(i,val){width-=parseInt(style[val],10)})}else{width=Math.max($ta.width(),0)}mirror.style.width=width+"px"}function initMirror(){var styles={};mirrored=ta;mirror.className=options.className;mirror.id=options.id;maxHeight=parseInt($ta.css("maxHeight"),10);$.each(typographyStyles,function(i,val){styles[val]=$ta.css(val)});$(mirror).css(styles);setWidth();if(window.chrome){var width=ta.style.width;ta.style.width="0px";var ignore=ta.offsetWidth;ta.style.width=width}}function adjust(){var height,original;if(mirrored!==ta){initMirror()}else{setWidth()}if(!ta.value&&options.placeholder){mirror.value=($ta.attr("placeholder")||"")+options.append}else{mirror.value=ta.value+options.append}mirror.style.overflowY=ta.style.overflowY;original=parseInt(ta.style.height,10);mirror.scrollTop=0;mirror.scrollTop=9e4;height=mirror.scrollTop;if(maxHeight&&height>maxHeight){ta.style.overflowY="scroll";height=maxHeight}else{ta.style.overflowY="hidden";if(height<minHeight){height=minHeight}}height+=boxOffset;if(original!==height){ta.style.height=height+"px";if(callback){options.callback.call(ta,ta)}}}function resize(){clearTimeout(timeout);timeout=setTimeout(function(){var newWidth=$ta.width();if(newWidth!==width){width=newWidth;adjust()}},parseInt(options.resizeDelay,10))}if("onpropertychange"in ta){if("oninput"in ta){$ta.on("input.autosize keyup.autosize",adjust)}else{$ta.on("propertychange.autosize",function(){if(event.propertyName==="value"){adjust()}})}}else{$ta.on("input.autosize",adjust)}if(options.resizeDelay!==false){$(window).on("resize.autosize",resize)}$ta.on("autosize.resize",adjust);$ta.on("autosize.resizeIncludeStyle",function(){mirrored=null;adjust()});$ta.on("autosize.destroy",function(){mirrored=null;clearTimeout(timeout);$(window).off("resize",resize);$ta.off("autosize").off(".autosize").css(originalStyles).removeData("autosize")});adjust()})}})(window.jQuery||window.$);var ChatJsUtils=function(){function ChatJsUtils(){}ChatJsUtils.setOuterHeight=function(jQuery,height){var heights=new Array;heights.push(parseInt(jQuery.css("padding-top").replace("px","")));heights.push(parseInt(jQuery.css("padding-bottom").replace("px","")));heights.push(parseInt(jQuery.css("border-top-width").replace("px","")));heights.push(parseInt(jQuery.css("border-bottom-width").replace("px","")));heights.push(parseInt(jQuery.css("margin-top").replace("px","")));heights.push(parseInt(jQuery.css("margin-bottom").replace("px","")));var calculatedHeight=height;for(var i=0;i<heights.length;i++)calculatedHeight-=heights[i];jQuery.height(calculatedHeight)};ChatJsUtils.setOuterWidth=function(jQuery,width){var widths=new Array;widths.push(parseInt(jQuery.css("padding-left").replace("px","")));widths.push(parseInt(jQuery.css("padding-right").replace("px","")));widths.push(parseInt(jQuery.css("border-top-left").replace("px","")));widths.push(parseInt(jQuery.css("border-bottom-right").replace("px","")));widths.push(parseInt(jQuery.css("margin-left").replace("px","")));widths.push(parseInt(jQuery.css("margin-right").replace("px","")));var calculatedWidth=width;for(var i=0;i<widths.length;i++)calculatedWidth-=widths[i];jQuery.width(calculatedWidth)};return ChatJsUtils}();var ChatJsUtils=function(){function ChatJsUtils(){}ChatJsUtils.setOuterHeight=function(jQuery,height){var heights=new Array;heights.push(parseInt(jQuery.css("padding-top").replace("px","")));heights.push(parseInt(jQuery.css("padding-bottom").replace("px","")));heights.push(parseInt(jQuery.css("border-top-width").replace("px","")));heights.push(parseInt(jQuery.css("border-bottom-width").replace("px","")));heights.push(parseInt(jQuery.css("margin-top").replace("px","")));heights.push(parseInt(jQuery.css("margin-bottom").replace("px","")));var calculatedHeight=height;for(var i=0;i<heights.length;i++)calculatedHeight-=heights[i];jQuery.height(calculatedHeight)};ChatJsUtils.setOuterWidth=function(jQuery,width){var widths=new Array;widths.push(parseInt(jQuery.css("padding-left").replace("px","")));widths.push(parseInt(jQuery.css("padding-right").replace("px","")));widths.push(parseInt(jQuery.css("border-top-left").replace("px","")));widths.push(parseInt(jQuery.css("border-bottom-right").replace("px","")));widths.push(parseInt(jQuery.css("margin-left").replace("px","")));widths.push(parseInt(jQuery.css("margin-right").replace("px","")));var calculatedWidth=width;for(var i=0;i<widths.length;i++)calculatedWidth-=widths[i];jQuery.width(calculatedWidth)};return ChatJsUtils}();var ChatMessageInfo=function(){function ChatMessageInfo(){}return ChatMessageInfo}();var UserStatusType;(function(UserStatusType){UserStatusType[UserStatusType["Offline"]=0]="Offline";UserStatusType[UserStatusType["Online"]=1]="Online"})(UserStatusType||(UserStatusType={}));var ChatMeetingInfo=function(){function ChatMeetingInfo(){}return ChatMeetingInfo}();var ChatUserInfo=function(){function ChatUserInfo(){}return ChatUserInfo}();var ChatRoomInfo=function(){function ChatRoomInfo(){}return ChatRoomInfo}();var ChatTypingSignalInfo=function(){function ChatTypingSignalInfo(){}return ChatTypingSignalInfo}();var ChatUserListChangedInfo=function(){function ChatUserListChangedInfo(){}return ChatUserListChangedInfo}();var ChatRoomListChangedInfo=function(){function ChatRoomListChangedInfo(){}return ChatRoomListChangedInfo}();var SignalRServerAdapter=function(){function SignalRServerAdapter(chatHubServer){this.hubServer=chatHubServer}SignalRServerAdapter.prototype.sendMessage=function(roomId,conversationId,otherUserId,messageText,clientGuid,done){this.hubServer.sendMessage(roomId,conversationId,otherUserId,messageText,clientGuid).done(function(){done()})};SignalRServerAdapter.prototype.sendTypingSignal=function(roomId,conversationId,userToId,done){this.hubServer.sendTypingSignal(roomId,conversationId,userToId).done(function(){done()})};SignalRServerAdapter.prototype.getMessageHistory=function(roomId,conversationId,otherUserId,done){this.hubServer.getMessageHistory(roomId,conversationId,otherUserId).done(function(messageHistory){done(messageHistory)})};SignalRServerAdapter.prototype.getUserInfo=function(userId,done){this.hubServer.getUserInfo(userId).done(function(userInfo){done(userInfo)})};SignalRServerAdapter.prototype.getUserList=function(roomId,conversationId,done){this.hubServer.getUserList(roomId,conversationId).done(function(userList){done(userList)})};SignalRServerAdapter.prototype.getRoomsList=function(done){this.hubServer.getRoomsList().done(function(roomsList){done(roomsList)})};SignalRServerAdapter.prototype.enterRoom=function(roomId,done){this.hubServer.enterRoom(roomId).done(function(){done()})};SignalRServerAdapter.prototype.leaveRoom=function(roomId,done){this.hubServer.leaveRoom(roomId).done(function(){done()})};return SignalRServerAdapter}();var SignalRClientAdapter=function(){function SignalRClientAdapter(chatHubClient){var _this=this;this.messagesChangedHandlers=[];this.typingSignalReceivedHandlers=[];this.userListChangedHandlers=[];this.roomListChangedHandlers=[];this.hubClient=chatHubClient;this.hubClient.sendMessage=function(message){_this.triggerMessagesChanged(message)};this.hubClient.sendTypingSignal=function(typingSignal){_this.triggerTypingSignalReceived(typingSignal)};this.hubClient.userListChanged=function(userListChangedInfo){_this.triggerUserListChanged(userListChangedInfo)};this.hubClient.roomListChanged=function(roomListChangedInfo){_this.triggerRoomListChanged(roomListChangedInfo)}}SignalRClientAdapter.prototype.onMessagesChanged=function(handler){this.messagesChangedHandlers.push(handler)};SignalRClientAdapter.prototype.onTypingSignalReceived=function(handler){this.typingSignalReceivedHandlers.push(handler)};SignalRClientAdapter.prototype.onUserListChanged=function(handler){this.userListChangedHandlers.push(handler)};SignalRClientAdapter.prototype.onRoomListChanged=function(handler){this.roomListChangedHandlers.push(handler)};SignalRClientAdapter.prototype.triggerMessagesChanged=function(message){for(var i=0;i<this.messagesChangedHandlers.length;i++)this.messagesChangedHandlers[i](message)};SignalRClientAdapter.prototype.triggerTypingSignalReceived=function(typingSignal){for(var i=0;i<this.typingSignalReceivedHandlers.length;i++)this.typingSignalReceivedHandlers[i](typingSignal)};SignalRClientAdapter.prototype.triggerUserListChanged=function(userListChangedInfo){for(var i=0;i<this.userListChangedHandlers.length;i++)this.userListChangedHandlers[i](userListChangedInfo)};SignalRClientAdapter.prototype.triggerRoomListChanged=function(roomListChangedInfo){for(var i=0;i<this.roomListChangedHandlers.length;i++)this.roomListChangedHandlers[i](roomListChangedInfo)};return SignalRClientAdapter}();var SignalRAdapterOptions=function(){function SignalRAdapterOptions(){}return SignalRAdapterOptions}();var SignalRAdapter=function(){function SignalRAdapter(options){var defaultOptions=new SignalRAdapterOptions;defaultOptions.chatHubName="chatHub";this.options=$.extend({},defaultOptions,options)}SignalRAdapter.prototype.init=function(done){this.hub=$.connection[this.options.chatHubName];this.client=new SignalRClientAdapter(this.hub.client);this.server=new SignalRServerAdapter(this.hub.server);if(!window.chatJsHubReady)window.chatJsHubReady=$.connection.hub.start();window.chatJsHubReady.done(function(){done()})};return SignalRAdapter}();var ChatWindowOptions=function(){function ChatWindowOptions(){}return ChatWindowOptions}();var ChatWindow=function(){function ChatWindow(options){var _this=this;var defaultOptions=new ChatWindowOptions;defaultOptions.isMaximized=true;defaultOptions.canClose=true;defaultOptions.onCreated=function(){};defaultOptions.onClose=function(){};defaultOptions.onMaximizedStateChanged=function(){};this.options=$.extend({},defaultOptions,options);this.$window=$("<div/>").addClass("chat-window").appendTo($("body"));if(this.options.width)this.$window.css("width",this.options.width);this.$windowTitle=$("<div/>").addClass("chat-window-title").appendTo(this.$window);if(this.options.canClose){var $closeButton=$("<div/>").addClass("close").appendTo(this.$windowTitle);$closeButton.click(function(e){e.stopPropagation();_this.$window.remove();_this.options.onClose(_this)})}$("<div/>").addClass("text").text(this.options.title).appendTo(this.$windowTitle);this.$windowContent=$("<div/>").addClass("chat-window-content").appendTo(this.$window);if(this.options.height)this.$windowContent.css("height",this.options.height);this.$windowInnerContent=$("<div/>").addClass("chat-window-inner-content").appendTo(this.$windowContent);this.$windowTitle.click(function(){_this.toggleMaximizedState()});this.setState(this.options.isMaximized,false);this.options.onCreated(this)}ChatWindow.prototype.getWidth=function(){return this.$window.outerWidth()};ChatWindow.prototype.setRightOffset=function(offset){this.$window.css("right",offset)};ChatWindow.prototype.getRightOffset=function(){var offset=this.$window.css("right").slice(0,-2);return parseInt(offset,10)};ChatWindow.prototype.setTitle=function(title){$("div[class=text]",this.$windowTitle).text(title)};ChatWindow.prototype.setVisible=function(visible){if(visible)this.$window.show();else this.$window.hide()};ChatWindow.prototype.getState=function(){return!this.$window.hasClass("minimized")};ChatWindow.prototype.setState=function(state,triggerMaximizedStateEvent){if(triggerMaximizedStateEvent===void 0){triggerMaximizedStateEvent=true}if(state){this.$window.removeClass("minimized");this.$windowContent.show()}else{this.$window.addClass("minimized");this.$windowContent.hide()}if(triggerMaximizedStateEvent)this.options.onMaximizedStateChanged(this,state)};ChatWindow.prototype.toggleMaximizedState=function(){this.setState(this.$window.hasClass("minimized"))};ChatWindow.prototype.focus=function(){};return ChatWindow}();$.chatWindow=function(options){var chatWindow=new ChatWindow(options);return chatWindow};var MessageBoardOptions=function(){function MessageBoardOptions(){}return MessageBoardOptions}();var MessageBoard=function(){function MessageBoard(jQuery,options){var _this=this;this.$el=jQuery;var defaultOptions=new MessageBoardOptions;defaultOptions.typingText=" is typing...";defaultOptions.playSound=true;defaultOptions.height=100;defaultOptions.chatJsContentPath="/chatjs/";defaultOptions.newMessage=function(message){};defaultOptions.displayName=true;this.options=$.extend({},defaultOptions,options);this.$el.addClass("message-board");ChatJsUtils.setOuterHeight(this.$el,this.options.height);this.$messagesWrapper=$("<div/>").addClass("messages-wrapper").appendTo(this.$el);var $windowTextBoxWrapper=$("<div/>").addClass("chat-window-text-box-wrapper").appendTo(this.$el);this.$textBox=$("<textarea />").attr("rows","1").addClass("chat-window-text-box").appendTo($windowTextBoxWrapper);this.$textBox.autosize({callback:function(ta){var messagesHeight=_this.options.height-$(ta).outerHeight();ChatJsUtils.setOuterHeight(_this.$messagesWrapper,messagesHeight)}});this.$textBox.val(this.$textBox.val());this.options.adapter.client.onTypingSignalReceived(function(typingSignal){var shouldProcessTypingSignal=false;if(_this.options.otherUserId){shouldProcessTypingSignal=typingSignal.UserToId==_this.options.userId&&typingSignal.UserFrom.Id==_this.options.otherUserId}else if(_this.options.roomId){shouldProcessTypingSignal=typingSignal.RoomId==_this.options.roomId&&typingSignal.UserFrom.Id!=_this.options.userId}else if(_this.options.conversationId){shouldProcessTypingSignal=typingSignal.ConversationId==_this.options.conversationId&&typingSignal.UserFrom.Id!=_this.options.userId}if(shouldProcessTypingSignal)_this.showTypingSignal(typingSignal.UserFrom)});this.options.adapter.client.onMessagesChanged(function(message){var shouldProcessMessage=false;var otherUserId=_this.options.otherUserId;var userId=_this.options.userId;if(otherUserId){shouldProcessMessage=message.UserFromId==userId&&message.UserToId==otherUserId||message.UserFromId==otherUserId&&message.UserToId==userId}else if(_this.options.roomId){shouldProcessMessage=message.RoomId==_this.options.roomId}else if(_this.options.conversationId){shouldProcessMessage=message.ConversationId==_this.options.conversationId}if(message.IsSystemMessage&&message.ConversationId!=_this.options.conversationId){return}if(shouldProcessMessage){_this.addMessage(message);if(message.UserFromId!=_this.options.userId){if(_this.options.playSound)_this.playSound()}_this.options.newMessage(message)}});this.options.adapter.server.getMessageHistory(this.options.roomId,this.options.conversationId,this.options.otherUserId,function(messages){for(var i=0;i<messages.length;i++){_this.addMessage(messages[i],false)}_this.adjustScroll();_this.$textBox.keypress(function(e){if(_this.sendTypingSignalTimeout==undefined){_this.sendTypingSignalTimeout=setTimeout(function(){_this.sendTypingSignalTimeout=undefined},3e3);_this.sendTypingSignal()}if(e.which==13){e.preventDefault();if(_this.$textBox.val()){_this.sendMessage(_this.$textBox.val());_this.$textBox.val("").trigger("autosize.resize")}}})})}MessageBoard.prototype.showTypingSignal=function(user){var _this=this;if(this.$typingSignal)this.$typingSignal.remove();this.$typingSignal=$("<p/>").addClass("typing-signal").text(user.Name+this.options.typingText);this.$messagesWrapper.append(this.$typingSignal);if(this.typingSignalTimeout)clearTimeout(this.typingSignalTimeout);this.typingSignalTimeout=setTimeout(function(){_this.removeTypingSignal()},5e3);this.adjustScroll()};MessageBoard.prototype.removeTypingSignal=function(){if(this.$typingSignal)this.$typingSignal.remove();if(this.typingSignalTimeout)clearTimeout(this.typingSignalTimeout)};MessageBoard.prototype.adjustScroll=function(){this.$messagesWrapper[0].scrollTop=this.$messagesWrapper[0].scrollHeight};MessageBoard.prototype.sendTypingSignal=function(){this.options.adapter.server.sendTypingSignal(this.options.roomId,this.options.conversationId,this.options.otherUserId,function(){})};MessageBoard.prototype.sendMessage=function(messageText){var generateGuidPart=function(){return((1+Math.random())*65536|0).toString(16).substring(1)};var clientGuid=generateGuidPart()+generateGuidPart()+"-"+generateGuidPart()+"-"+generateGuidPart()+"-"+generateGuidPart()+"-"+generateGuidPart()+generateGuidPart()+generateGuidPart();var message=new ChatMessageInfo;message.UserFromId=this.options.userId;message.Message=messageText;message.ClientGuid=clientGuid;this.addMessage(message);this.options.adapter.server.sendMessage(this.options.roomId,this.options.conversationId,this.options.otherUserId,messageText,clientGuid,function(){})};MessageBoard.prototype.playSound=function(){var $soundContainer=$("#soundContainer");if(!$soundContainer.length)$soundContainer=$("<div>").attr("id","soundContainer").appendTo($("body"));var baseFileName=this.options.chatJsContentPath+"sounds/chat";var oggFileName=baseFileName+".ogg";var mp3FileName=baseFileName+".mp3";var $audioTag=$("<audio/>").attr("autoplay","autoplay");$("<source/>").attr("src",oggFileName).attr("type","audio/mpeg").appendTo($audioTag);$("<embed/>").attr("src",mp3FileName).attr("autostart","true").attr("loop","false").appendTo($audioTag);$audioTag.appendTo($soundContainer)};MessageBoard.prototype.focus=function(){this.$textBox.focus()};MessageBoard.prototype.addMessage=function(message,scroll){var _this=this;if(scroll==undefined)scroll=true;if(message.UserFromId!=this.options.userId){this.removeTypingSignal()}function linkify($element){var inputText=$element.html();var replacedText,replacePattern1,replacePattern2,replacePattern3;replacePattern1=/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim;replacedText=inputText.replace(replacePattern1,'<a href="$1" target="_blank">$1</a>');replacePattern2=/(^|[^\/])(www\.[\S]+(\b|$))/gim;replacedText=replacedText.replace(replacePattern2,'$1<a href="http://$2" target="_blank">$2</a>');replacePattern3=/(\w+@[a-zA-Z_]+?\.[a-zA-Z]{2,6})/gim;replacedText=replacedText.replace(replacePattern3,'<a href="mailto:$1">$1</a>');return $element.html(replacedText)}function emotify($element){var inputText=$element.html();var replacedText=inputText;var emoticons=[{pattern:":-)",cssClass:"happy"},{pattern:":)",cssClass:"happy"},{pattern:"=)",cssClass:"happy"},{pattern:":-D",cssClass:"very-happy"},{pattern:":D",cssClass:"very-happy"},{pattern:"=D",cssClass:"very-happy"},{pattern:":-(",cssClass:"sad"},{pattern:":(",cssClass:"sad"},{pattern:"=(",cssClass:"sad"},{pattern:":-|",cssClass:"wary"},{pattern:":|",cssClass:"wary"},{pattern:"=|",cssClass:"wary"},{pattern:":-O",cssClass:"astonished"},{pattern:":O",cssClass:"astonished"},{pattern:"=O",cssClass:"astonished"},{pattern:":-P",cssClass:"tongue"},{pattern:":P",cssClass:"tongue"},{pattern:"=P",cssClass:"tongue"}];for(var i=0;i<emoticons.length;i++){replacedText=replacedText.replace(emoticons[i].pattern,"<span class='"+emoticons[i].cssClass+"'></span>")}return $element.html(replacedText)}if(message.ClientGuid&&$("p[data-val-client-guid='"+message.ClientGuid+"']").length){$("p[data-val-client-guid='"+message.ClientGuid+"']").removeClass("temp-message").removeAttr("data-val-client-guid")}else{var $messageP=$("<p/>").text(message.Message);if(message.ClientGuid)$messageP.attr("data-val-client-guid",message.ClientGuid).addClass("temp-message");linkify($messageP);emotify($messageP);var $lastMessage=$("div.chat-message:last",this.$messagesWrapper);if($lastMessage.length&&$lastMessage.attr("data-val-user-from")==message.UserFromId.toString()){$messageP.appendTo($(".chat-text-wrapper",$lastMessage))}else{var $chatMessage=$("<div/>").addClass("chat-message").attr("data-val-user-from",message.UserFromId);$chatMessage.appendTo(this.$messagesWrapper);var $gravatarWrapper=$("<div/>").addClass("chat-gravatar-wrapper").appendTo($chatMessage);if(this.options.displayName){var $nameWrapper=$("<div/>").addClass("chat-name-wrapper").appendTo($chatMessage)}var $textWrapper=$("<div/>").addClass("chat-text-wrapper").appendTo($chatMessage);$messageP.appendTo($textWrapper);var $img=$("<img/>").addClass("profile-picture").appendTo($gravatarWrapper);console.log(message.UserFromId);this.options.adapter.server.getUserInfo(message.UserFromId,function(user){$img.attr("src",decodeURI(user.ProfilePictureUrl));if(_this.options.displayName){$("<p>"+user.Name+"</p>").appendTo($nameWrapper)}})}}if(scroll)this.adjustScroll()};return MessageBoard}();$.fn.messageBoard=function(options){if(this.length){this.each(function(){var data=new MessageBoard($(this),options);$(this).data("messageBoard",data)})}return this};var UserListOptions=function(){function UserListOptions(){}return UserListOptions}();var UserList=function(){function UserList(jQuery,options){var _this=this;this.$el=jQuery;var defaultOptions=new UserListOptions;defaultOptions.emptyRoomText="No users available for chatting.";defaultOptions.height=100;defaultOptions.excludeCurrentUser=false;defaultOptions.userClicked=function(){};this.options=$.extend({},defaultOptions,options);this.$el.addClass("user-list");ChatJsUtils.setOuterHeight(this.$el,this.options.height);this.options.adapter.client.onUserListChanged(function(userListData){if(_this.options.roomId&&userListData.RoomId==_this.options.roomId||_this.options.conversationId&&_this.options.conversationId==userListData.ConversationId){var userList=userListData.UserList;_this.populateList(userList)}});this.options.adapter.server.getUserList(this.options.roomId,this.options.conversationId,function(userList){_this.populateList(userList)})}UserList.prototype.populateList=function(rawUserList){var _this=this;var userList=rawUserList.slice(0);if(this.options.excludeCurrentUser){var j=0;while(j<userList.length){if(userList[j].Id==this.options.userId)userList.splice(j,1);else j++}}if(this.options.filterUserIds&&this.options.filterUserIds.length>0){var newUserList=Array();var j=0;while(j<userList.length){if(this.options.filterUserIds.indexOf(userList[j].Id.toString())==-1){newUserList.push(userList[j])}j++}userList=newUserList}this.$el.html("");if(userList.length==0){$("<div/>").addClass("user-list-empty").text(this.options.emptyRoomText).appendTo(this.$el)}else{for(var i=0;i<userList.length;i++){var $userListItem=$("<div/>").addClass("user-list-item").attr("data-val-id",userList[i].Id).appendTo(this.$el);$("<img/>").addClass("profile-picture").attr("src",userList[i].ProfilePictureUrl).appendTo($userListItem);$("<div/>").addClass("profile-status").addClass(userList[i].Status==0?"offline":"online").appendTo($userListItem);$("<div/>").addClass("content").text(userList[i].Name).appendTo($userListItem);(function(userId){$userListItem.click(function(){_this.options.userClicked(userId)})})(userList[i].Id)}}};return UserList}();$.fn.userList=function(options){if(this.length){this.each(function(){var data=new UserList($(this),options);$(this).data("userList",data)})}return this};var MeetingListOptions=function(){function MeetingListOptions(){}return MeetingListOptions}();var MeetingList=function(){function MeetingList(jQuery,options){var _this=this;this.$el=jQuery;var defaultOptions=new MeetingListOptions;defaultOptions.emptyMeetingText="No users available for chatting.";defaultOptions.height=100;defaultOptions.meetingClicked=function(){};this.options=$.extend({},defaultOptions,options);this.$el.addClass("user-list");ChatJsUtils.setOuterHeight(this.$el,this.options.height);this.options.adapter.server.getMeetingList(this.options.roomId,function(meetingList){_this.populateList(meetingList)})}MeetingList.prototype.populateList=function(rawUserList){var userList=rawUserList.slice(0);this.$el.html("");if(userList.length==0){$("<div/>").addClass("user-list-empty").text(this.options.emptyMeetingText).appendTo(this.$el)}else{for(var i=0;i<userList.length;i++){var $userListItem=$("<div/>").addClass("user-list-item").attr("data-val-id",userList[i].Id).appendTo(this.$el);$("<div/>").addClass("content").text(userList[i].Name).appendTo($userListItem)}}};return MeetingList}();$.fn.meetingList=function(options){if(this.length){this.each(function(){var data=new MeetingList($(this),options);$(this).data("meetingList",data)})}return this};var PmWindowInfo=function(){function PmWindowInfo(){}return PmWindowInfo}();var PmWindowState=function(){function PmWindowState(){}return PmWindowState}();var ChatPmWindowOptions=function(){function ChatPmWindowOptions(){}return ChatPmWindowOptions}();var ChatPmWindow=function(){function ChatPmWindow(options){var _this=this;var defaultOptions=new ChatPmWindowOptions;defaultOptions.typingText=" is typing...";defaultOptions.isMaximized=true;defaultOptions.onCreated=function(){};defaultOptions.onClose=function(){};defaultOptions.chatJsContentPath="/chatjs/";this.options=$.extend({},defaultOptions,options);if(this.options.otherUserId){this.options.adapter.server.getUserInfo(this.options.otherUserId,function(userInfo){_this.options.chattingUserIds=new Array;_this.options.chattingUserIds.push(_this.options.userId.toString());_this.options.chattingUserIds.push(_this.options.otherUserId.toString());var chatWindowOptions=_this._setupChatWindowOptions(userInfo.Name,null,_this.options.otherUserId);_this.chatWindow=$.chatWindow(chatWindowOptions);_this._setupInviteButton();_this.options.onCreated(_this)})}else if(this.options.conversationId){var convId=this.options.conversationId;this.options.adapter.server.getUserList(1,convId,function(users){var existingUserIds=new Array;for(var i=0;i<users.length;i++){existingUserIds.push(users[i].Id.toString())}_this.options.chattingUserIds=existingUserIds;var windowTitle=_this._genWindowTitle();var chatWindowOptions=_this._setupChatWindowOptions(windowTitle,convId,null);_this.chatWindow=$.chatWindow(chatWindowOptions);_this._setupInviteButton();_this.options.onCreated(_this)})}}ChatPmWindow.prototype._setupChatWindowOptions=function(title,convId,otherUserId){var _this=this;var chatWindowOptions=new ChatWindowOptions;chatWindowOptions.title=title;chatWindowOptions.canClose=true;chatWindowOptions.isMaximized=this.options.isMaximized;chatWindowOptions.onCreated=function(window){var messageBoardOptions=new MessageBoardOptions;messageBoardOptions.adapter=_this.options.adapter;messageBoardOptions.userId=_this.options.userId;messageBoardOptions.height=235;messageBoardOptions.otherUserId=otherUserId;messageBoardOptions.conversationId=convId;messageBoardOptions.chatJsContentPath=_this.options.chatJsContentPath;messageBoardOptions.newMessage=function(message){if(message.ConversationId==_this.options.conversationId&&message.IsSystemMessage){var ids=message.NewAddedUserIds;for(var i=0;i<ids.length;i++){_this.options.chattingUserIds.push(ids[i].toString())}_this._refreshWindowTitle()}};window.$windowInnerContent.messageBoard(messageBoardOptions);window.$windowInnerContent.addClass("pm-window")};chatWindowOptions.onClose=function(){_this.options.onClose(_this)};chatWindowOptions.onMaximizedStateChanged=function(chatPmWindow,isMaximized){_this.options.onMaximizedStateChanged(_this,isMaximized)};return chatWindowOptions};ChatPmWindow.prototype._setupInviteButton=function(){var _this=this;var $addUserButton=$("<div/>").addClass("invite-user").prependTo(this.chatWindow.$windowTitle);$addUserButton.click(function(e){e.stopPropagation();var popupWindowOptions=new ChatFriendsWindowOptions;popupWindowOptions.roomId=1;popupWindowOptions.adapter=_this.options.adapter;popupWindowOptions.userId=_this.options.userId;popupWindowOptions.offsetRight=_this.getRightOffset();popupWindowOptions.titleText="Add user to meeting";popupWindowOptions.isMaximized=true;popupWindowOptions.isPopUp=true;popupWindowOptions.contentHeight=400;popupWindowOptions.filterUserIds=new Array;popupWindowOptions.filterUserIds=_this.options.chattingUserIds;popupWindowOptions.onStateChanged=function(){};popupWindowOptions.userClicked=function(userId){var ids=_this.options.chattingUserIds;if(ids.indexOf(userId.toString())!=-1){return}var convId=_this.options.conversationId;if(convId){_this.options.adapter.server.addOneParticipant(convId,_this.options.chattingUserIds,userId.toString());_this.options.chattingUserIds.push(userId.toString());_this._refreshWindowTitle()}else{convId=_this.options.adapter.server.addOneParticipant(null,_this.options.chattingUserIds,userId.toString());_this.options.onParticipantInvited(_this,convId)}_this.options.conversationId=convId;_this.inviteUserWindow.chatWindow.$window.remove()};_this.inviteUserWindow=new ChatFriendsWindow(popupWindowOptions)})};ChatPmWindow.prototype._refreshWindowTitle=function(){this.chatWindow.$windowTitle.find(".text").text(this._genWindowTitle())};ChatPmWindow.prototype._genWindowTitle=function(){return"Meeting ("+this.options.chattingUserIds.length.toString()+" people)"};ChatPmWindow.prototype.focus=function(){};ChatPmWindow.prototype.setRightOffset=function(offset){this.chatWindow.setRightOffset(offset)};ChatPmWindow.prototype.getRightOffset=function(){return this.chatWindow.getRightOffset()};ChatPmWindow.prototype.getWidth=function(){return this.chatWindow.getWidth()};ChatPmWindow.prototype.getState=function(){var state=new PmWindowState;state.isMaximized=this.chatWindow.getState();state.otherUserId=this.options.otherUserId;return state};ChatPmWindow.prototype.setState=function(state){this.chatWindow.setState(state.isMaximized)};return ChatPmWindow}();$.chatPmWindow=function(options){var pmWindow=new ChatPmWindow(options);return pmWindow};var ChatFriendsWindowState=function(){function ChatFriendsWindowState(){}return ChatFriendsWindowState}();var ChatFriendsWindowOptions=function(){function ChatFriendsWindowOptions(){}return ChatFriendsWindowOptions}();var ChatFriendsWindow=function(){function ChatFriendsWindow(options){var _this=this;var defaultOptions=new ChatFriendsWindowOptions;defaultOptions.titleText="Friends";defaultOptions.isMaximized=true;defaultOptions.offsetRight=10;defaultOptions.contentHeight=500;defaultOptions.emptyRoomText="No users available for chatting.";this.options=$.extend({},defaultOptions,options);this.options.adapter.server.enterRoom(this.options.roomId,function(){});

var chatWindowOptions=new ChatWindowOptions;chatWindowOptions.title=this.options.titleText;chatWindowOptions.canClose=this.options.isPopUp;chatWindowOptions.height=300;chatWindowOptions.isMaximized=this.options.isMaximized;chatWindowOptions.onMaximizedStateChanged=function(chatWindow,isMaximized){_this.options.onStateChanged(isMaximized)};chatWindowOptions.onCreated=function(window){_this.showUserList(window)};this.chatWindow=$.chatWindow(chatWindowOptions);this.chatWindow.setRightOffset(this.options.offsetRight);if(this.options.isPopUp){return}return;this.$windowInnerTabs=$("<ul/>").addClass("chat-window-inner-tabs").prependTo(this.chatWindow.$windowContent);this.$windowInnerTabFriends=$("<li><a herf='javascript:;'>private chat</a></li>").addClass("chat-window-inner-tab current").appendTo(this.$windowInnerTabs);this.$windowInnerTabGroups=$("<li><a herf='javascript:;'>group chat</a></li>").addClass("chat-window-inner-tab").appendTo(this.$windowInnerTabs);this.$windowInnerTabFriends.click(function(){_this.switchToPrivateChatTab()});this.$windowInnerTabGroups.click(function(){_this.switchToGroupChat()})}ChatFriendsWindow.prototype.switchToPrivateChatTab=function(){this.$windowInnerTabFriends.addClass("current");this.$windowInnerTabGroups.removeClass("current");this.showUserList(this.chatWindow)};ChatFriendsWindow.prototype.showUserList=function(window){var userListOptions=new UserListOptions;userListOptions.adapter=this.options.adapter;userListOptions.roomId=this.options.roomId;userListOptions.userId=this.options.userId;userListOptions.height=this.options.contentHeight;userListOptions.excludeCurrentUser=true;userListOptions.emptyRoomText=this.options.emptyRoomText;userListOptions.userClicked=this.options.userClicked;userListOptions.filterUserIds=this.options.filterUserIds;window.$windowInnerContent.userList(userListOptions)};ChatFriendsWindow.prototype.showMeetingList=function(){var meetingListOptions=new MeetingListOptions;meetingListOptions.adapter=this.options.adapter;meetingListOptions.roomId=this.options.roomId;meetingListOptions.meetingClicked=this.options.userClicked;this.chatWindow.$windowInnerContent.meetingList(meetingListOptions)};ChatFriendsWindow.prototype.switchToGroupChat=function(){this.$windowInnerTabFriends.removeClass("current");this.$windowInnerTabGroups.addClass("current");this.showMeetingList()};ChatFriendsWindow.prototype.focus=function(){};ChatFriendsWindow.prototype.setRightOffset=function(offset){this.chatWindow.setRightOffset(offset)};ChatFriendsWindow.prototype.getRightOffset=function(){return this.chatWindow.getRightOffset()};ChatFriendsWindow.prototype.getWidth=function(){return this.chatWindow.getWidth()};ChatFriendsWindow.prototype.getState=function(){var state=new ChatFriendsWindowState;state.isMaximized=this.chatWindow.getState();return state};ChatFriendsWindow.prototype.setState=function(state){this.chatWindow.setState(state.isMaximized)};return ChatFriendsWindow}();$.chatFriendsWindow=function(options){var friendsWindow=new ChatFriendsWindow(options);return friendsWindow};var ChatControllerOptions=function(){function ChatControllerOptions(){}return ChatControllerOptions}();var ChatJsState=function(){function ChatJsState(){this.pmWindows=[];this.mainWindowState=new ChatFriendsWindowState}return ChatJsState}();var ChatController=function(){function ChatController(options){var _this=this;var defaultOptions=new ChatControllerOptions;defaultOptions.roomId=null;defaultOptions.friendsTitleText="Friends";defaultOptions.availableRoomsText="Available rooms";defaultOptions.typingText=" is typing...";defaultOptions.offsetRight=10;defaultOptions.windowsSpacing=5;defaultOptions.enableSound=true;defaultOptions.persistenceMode="cookie";defaultOptions.persistenceCookieName="chatjs";defaultOptions.chatJsContentPath="/chatjs/";this.options=$.extend({},defaultOptions,options);if(!this.options.roomId)throw"Room id option is required";this.pmWindows=[];this.options.adapter.init(function(currentUserId){if(currentUserId==-1){return}if(currentUserId!=0){_this.options.userId=currentUserId}var state=_this.getState();_this.options.adapter.client.onMessagesChanged(function(message){var myId=_this.options.userId;if(message.UserToId&&message.UserToId==myId&&!_this.findPmWindowByOtherUserId(message.UserFromId)){_this.createPmWindow(message.UserFromId,null,true,true)}else if(!_this.findPmWindowByConvId(message.ConversationId)){_this.createPmWindow(null,message.ConversationId,true,true)}});var friendsWindowOptions=new ChatFriendsWindowOptions;friendsWindowOptions.roomId=_this.options.roomId;friendsWindowOptions.adapter=_this.options.adapter;friendsWindowOptions.userId=_this.options.userId;friendsWindowOptions.offsetRight=_this.options.offsetRight;friendsWindowOptions.titleText=_this.options.friendsTitleText;friendsWindowOptions.isMaximized=state?state.mainWindowState.isMaximized:true;friendsWindowOptions.onStateChanged=function(){_this.saveState()};friendsWindowOptions.userClicked=function(userId){if(userId!=_this.options.userId){var existingPmWindow=_this.findPmWindowByOtherUserId(userId);if(existingPmWindow)existingPmWindow.focus();else _this.createPmWindow(userId,null,true,true)}};friendsWindowOptions.isPopUp=false;_this.mainWindow=$.chatFriendsWindow(friendsWindowOptions);_this.setState(state)});window.chatJs=this}ChatController.prototype.createPmWindow=function(otherUserId,convId,isMaximized,saveState){var _this=this;var chatPmOptions=new ChatPmWindowOptions;chatPmOptions.userId=this.options.userId;chatPmOptions.otherUserId=otherUserId;chatPmOptions.conversationId=convId;chatPmOptions.adapter=this.options.adapter;chatPmOptions.typingText=this.options.typingText;chatPmOptions.isMaximized=isMaximized;chatPmOptions.chatJsContentPath=this.options.chatJsContentPath;chatPmOptions.onCreated=function(pmWindow){_this.pmWindows.push({otherUserId:otherUserId,conversationId:convId,pmWindow:pmWindow});_this.organizePmWindows();if(saveState)_this.saveState()};chatPmOptions.onClose=function(){for(var i=0;i<_this.pmWindows.length;i++)if(_this.pmWindows[i].otherUserId==otherUserId){_this.pmWindows.splice(i,1);_this.saveState();_this.organizePmWindows();break}};chatPmOptions.onMaximizedStateChanged=function(){_this.saveState()};chatPmOptions.onParticipantInvited=function(pmWindow,convId){_this.createPmWindow(null,convId,true,true)};return $.chatPmWindow(chatPmOptions)};ChatController.prototype.saveState=function(){var state=new ChatJsState;for(var i=0;i<this.pmWindows.length;i++){state.pmWindows.push({otherUserId:this.pmWindows[i].otherUserId,conversationId:this.pmWindows[i].conversationId,isMaximized:this.pmWindows[i].pmWindow.getState().isMaximized})}state.mainWindowState=this.mainWindow.getState();switch(this.options.persistenceMode){case"cookie":this.createCookie(this.options.persistenceCookieName,state);break;case"server":throw"Server persistence is not supported yet";default:throw"Invalid persistence mode. Available modes are: cookie and server"}return state};ChatController.prototype.getState=function(){var state;switch(this.options.persistenceMode){case"cookie":state=this.readCookie(this.options.persistenceCookieName);break;case"server":throw"Server persistence is not supported yet";default:throw"Invalid persistence mode. Available modes are: cookie and server"}return state};ChatController.prototype.setState=function(state){if(state===void 0){state=null}if(!state)state=this.getState();if(!state)return;for(var i=0;i<state.pmWindows.length;i++){var shouldCreatePmWindow=true;if(this.pmWindows.length){for(var j=0;j<this.pmWindows.length;j++){if(state.pmWindows[i].otherUserId&&this.pmWindows[j].otherUserId==state.pmWindows[i].otherUserId){shouldCreatePmWindow=false;break}}}if(shouldCreatePmWindow)this.createPmWindow(state.pmWindows[i].otherUserId,state.pmWindows[i].conversationId,state.pmWindows[i].isMaximized,false)}this.mainWindow.setState(state.mainWindowState,false)};ChatController.prototype.eraseCookie=function(name){this.createCookie(name,"",-1)};ChatController.prototype.readCookie=function(name){var nameEq=name+"=";var ca=document.cookie.split(";");var cookieValue;for(var i=0;i<ca.length;i++){var c=ca[i];while(c.charAt(0)==" ")c=c.substring(1,c.length);if(c.indexOf(nameEq)==0){cookieValue=c.substring(nameEq.length,c.length)}}if(cookieValue){try{return JSON.parse(cookieValue)}catch(e){return cookieValue}}else return null};ChatController.prototype.createCookie=function(name,value,days){var stringedValue;if(typeof value=="string")stringedValue=value;else stringedValue=JSON.stringify(value);if(value)var expires;if(days){var date=new Date;date.setTime(date.getTime()+days*24*60*60*1e3);expires="; expires="+date.toUTCString()}else{expires=""}document.cookie=name+"="+stringedValue+expires+"; path=/"};ChatController.prototype.findPmWindowByOtherUserId=function(otherUserId){for(var i=0;i<this.pmWindows.length;i++)if(this.pmWindows[i].otherUserId==otherUserId)return this.pmWindows[i].pmWindow;return null};ChatController.prototype.findPmWindowByConvId=function(convId){for(var i=0;i<this.pmWindows.length;i++)if(this.pmWindows[i].conversationId==convId)return this.pmWindows[i].pmWindow;return null};ChatController.prototype.organizePmWindows=function(){var rightOffset=+this.options.offsetRight+this.mainWindow.getWidth()+this.options.windowsSpacing;for(var i=0;i<this.pmWindows.length;i++){this.pmWindows[i].pmWindow.setRightOffset(rightOffset);rightOffset+=this.pmWindows[i].pmWindow.getWidth()+this.options.windowsSpacing}};return ChatController}();$.chat=function(options){var chat=new ChatController(options);return chat};var QorChatAdapterConstants=function(){function QorChatAdapterConstants(){}QorChatAdapterConstants.CURRENT_USER_ID=1;QorChatAdapterConstants.ECHOBOT_USER_ID=2;QorChatAdapterConstants.DEFAULT_ROOM_ID=1;QorChatAdapterConstants.ECHOBOT_TYPING_DELAY=1e3;QorChatAdapterConstants.ECHOBOT_REPLY_DELAY=3e3;QorChatAdapterConstants.CHAT_SERVER_BASE_HTTP_URL="https://chatserver-qortex.theplant-dev.com";QorChatAdapterConstants.CHAT_SERVER_BASE_WS_URL="ws://chat_server.qortex.theplant-dev.com";return QorChatAdapterConstants}();var QueryConvOptions=function(){function QueryConvOptions(){this.participantEmails=new Array}return QueryConvOptions}();var AddParticipantOptions=function(){function AddParticipantOptions(){}return AddParticipantOptions}();var QorChatMessageOptions=function(){function QorChatMessageOptions(){}return QorChatMessageOptions}();var QorChatRosterAllDataPkg=function(){function QorChatRosterAllDataPkg(){this.dType="all";this.topic="roster"}return QorChatRosterAllDataPkg}();var QorChatPrivateDataPkg=function(){function QorChatPrivateDataPkg(msg){this.message=msg;this.dType="private";this.topic="messages"}return QorChatPrivateDataPkg}();var QorChatMeetingDataPkg=function(){function QorChatMeetingDataPkg(msg){this.message=msg;this.dType="group";this.topic="messages"}return QorChatMeetingDataPkg}();var QorChatNotificationOptions=function(){function QorChatNotificationOptions(){}return QorChatNotificationOptions}();var QorChatNotifyDataPkg=function(){function QorChatNotifyDataPkg(ntf){this.notification=ntf;this.dType="add_users";this.topic="notification"}return QorChatNotifyDataPkg}();var QorChatClientAdapter=function(){function QorChatClientAdapter(){this.messagesChangedHandlers=[];this.typingSignalReceivedHandlers=[];this.userListChangedHandlers=[]}QorChatClientAdapter.prototype.onMessagesChanged=function(handler){this.messagesChangedHandlers.push(handler)};QorChatClientAdapter.prototype.onTypingSignalReceived=function(handler){this.typingSignalReceivedHandlers.push(handler)};QorChatClientAdapter.prototype.onUserListChanged=function(handler){this.userListChangedHandlers.push(handler)};QorChatClientAdapter.prototype.triggerMessagesChanged=function(message){for(var i=0;i<this.messagesChangedHandlers.length;i++)this.messagesChangedHandlers[i](message)};QorChatClientAdapter.prototype.triggerTypingSignalReceived=function(typingSignal){for(var i=0;i<this.typingSignalReceivedHandlers.length;i++)this.typingSignalReceivedHandlers[i](typingSignal)};QorChatClientAdapter.prototype.triggerUserListChanged=function(userListChangedInfo){for(var i=0;i<this.userListChangedHandlers.length;i++)this.userListChangedHandlers[i](userListChangedInfo)};return QorChatClientAdapter}();var QorChatServerAdapter=function(){function QorChatServerAdapter(clientAdapter,email,token){this.clientAdapter=clientAdapter;this.qorchatToken=token;this.accessable=this._setCurrentUserAndUserList(email);if(!this.accessable){return}this.setupWsConn();var meeting1=new ChatMeetingInfo;meeting1.Id=1;meeting1.Name="Winter Dog";var meeting2=new ChatMeetingInfo;meeting2.Id=3;meeting2.Name="Summer Cat";var meeting3=new ChatMeetingInfo;meeting3.Id=5;meeting3.Name="Super Mario";this.meetings=new Array;this.meetings.push(meeting1);this.meetings.push(meeting2);this.meetings.push(meeting3);var defaultRoom=new ChatRoomInfo;defaultRoom.Id=1;defaultRoom.Name="Default Room";defaultRoom.UsersOnline=this.users.length;this.rooms=new Array;this.rooms.push(defaultRoom);this.clientAdapter.onMessagesChanged(function(message){return function(){}})}QorChatServerAdapter.prototype.setupWsConn=function(){var _this=this;var self=this;this.conn=new WebSocket(QorChatAdapterConstants.CHAT_SERVER_BASE_WS_URL+"/ws/theplant/"+self.qorchatToken);this.conn.onopen=function(evt){var data=new QorChatRosterAllDataPkg;var jsonStr=JSON.stringify(data);_this.conn.send(jsonStr)};this.conn.onerror=function(evt){console.log("ws errorr");console.log(evt)};this.conn.onclose=function(evt){var reconnectTime=Math.floor(Math.random()*10001)+3e3;setTimeout(function(){console.log("reconnect ws");self.setupWsConn()},reconnectTime)};this.conn.onmessage=function(evt){var data=JSON.parse(evt.data);if(!data){return}if(data.topic=="roster"){var onlineUsers=data.object;var users=self.users;if(data.dType=="all"){for(var j=0;j<onlineUsers.length;j++){for(var i=0;i<users.length;i++){if(onlineUsers[j].id==users[i].Id){self.users[i].Status=1;break}}}}else if(data.dType=="online"){for(var i=0;i<users.length;i++){if(data.object.id==users[i].Id){self.users[i].Status=1;break}}}else if(data.dType=="offline"){for(var i=0;i<users.length;i++){if(data.object.id==users[i].Id){self.users[i].Status=0;break}}}self.enterRoom(QorChatAdapterConstants.DEFAULT_ROOM_ID,function(){})}if(data.topic=="messages"){var msg=new ChatMessageInfo;msg.UserFromId=data.message.fromUserId;if(data.dType=="private"){msg.UserToId=data.message.receiverId}else if(data.dType=="group"){msg.ConversationId=data.message.convId}msg.RoomId=QorChatAdapterConstants.DEFAULT_ROOM_ID;msg.Message=data.message.content;_this.clientAdapter.triggerMessagesChanged(msg)}if(data.topic=="notification"){var inviter=_this._getUserByEmail(data.notification.inviter_email);var invitees=_this._getUserByEmails(data.notification.new_added_user_emails);var tips=inviter.Name+" added "+invitees[0].Name+" to this meeting";if(invitees.length>1){tips=inviter.Name+" added "+invitees.length.toString()+" people to this meeting"}var inviteeIds=new Array;for(var i=0;i<invitees.length;i++){inviteeIds.push(invitees[i].Id)}var msg=new ChatMessageInfo;msg.ConversationId=data.notification.convId;msg.UserFromId=inviter.Id;msg.RoomId=QorChatAdapterConstants.DEFAULT_ROOM_ID;msg.IsSystemMessage=true;msg.NewAddedUserIds=inviteeIds;msg.Message=tips;_this.clientAdapter.triggerMessagesChanged(msg)}}};QorChatServerAdapter.prototype.sendMessage=function(roomId,conversationId,otherUserId,messageText,clientGuid,done){console.log(messageText);console.log("QorChatServerAdapter: sendMessage");var msg=new QorChatMessageOptions;msg.content=messageText;msg.fromUserId=this.currentUser.Id.toString();msg.fromUserAvatar=this.currentUser.ProfilePictureUrl;var jsonStr="";if(conversationId){msg.convId=conversationId;msg.receiverId=conversationId;var data=new QorChatMeetingDataPkg(msg);jsonStr=JSON.stringify(data)}else{var emails=this._getPrivateConvEmails(otherUserId.toString());msg.convId=this._getConvByEmails(emails,true);msg.receiverId=otherUserId.toString();var data=new QorChatPrivateDataPkg(msg);jsonStr=JSON.stringify(data)}this.conn.send(jsonStr);console.log(jsonStr)};QorChatServerAdapter.prototype.sendTypingSignal=function(roomId,conversationId,userToId,done){return;console.log("QorChatServerAdapter: sendTypingSignal")};QorChatServerAdapter.prototype.getMessageHistory=function(roomId,conversationId,otherUserId,done){console.log("QorChatServerAdapter: getMessageHistory");if(!conversationId){var emails=this._getPrivateConvEmails(otherUserId.toString());conversationId=this._getConvByEmails(emails,true)}var msgs=this._getChatHistory(conversationId);done(msgs)};QorChatServerAdapter.prototype.getUserInfo=function(userId,done){console.log("QorChatServerAdapter: getUserInfo");if(!this.accessable){alert("maybe your email account was not ailable on demo.qortex.com @theplant org, contact yeer for solution:)");return}console.log(userId);var user=null;for(var i=0;i<this.users.length;i++){if(this.users[i].Id==userId){user=this.users[i];break}}if(user==null)throw"User doesn't exit. User id: "+userId;done(user)};QorChatServerAdapter.prototype.getUserList=function(roomId,conversationId,done){console.log("QorChatServerAdapter: getUserList");if(roomId==QorChatAdapterConstants.DEFAULT_ROOM_ID){if(conversationId){console.log(conversationId);var users=this._getConvParticipants(conversationId);done(users);return}done(this.users);return}throw"The given room or conversation is not supported by the demo adapter"};QorChatServerAdapter.prototype.getMeetingList=function(roomId,done){console.log("QorChatServerAdapter: getMeetingList");if(roomId==QorChatAdapterConstants.DEFAULT_ROOM_ID){done(this.meetings);return}throw"The given room or conversation is not supported by the demo adapter"};QorChatServerAdapter.prototype.enterRoom=function(roomId,done){console.log("QorChatServerAdapter: enterRoom");if(!this.accessable){return}if(roomId!=QorChatAdapterConstants.DEFAULT_ROOM_ID)throw"Only the default room is supported in the demo adapter";var userListChangedInfo=new ChatUserListChangedInfo;userListChangedInfo.RoomId=QorChatAdapterConstants.DEFAULT_ROOM_ID;userListChangedInfo.UserList=this.users;this.clientAdapter.triggerUserListChanged(userListChangedInfo)};QorChatServerAdapter.prototype.leaveRoom=function(roomId,done){console.log("QorChatServerAdapter: leaveRoom")};QorChatServerAdapter.prototype.addOneParticipant=function(convId,existUserIds,userId){if(existUserIds.length>2){this._addParticipantToMeeting(convId,userId);return convId}var emails=this._getMeetingConvEmails(existUserIds,userId);convId=this._getConvByEmails(emails,false);return convId};QorChatServerAdapter.prototype._getMeetingConvEmails=function(withUserIds,userId){var emails=new Array;for(var i=0;i<withUserIds.length;i++){var user=this._getUserById(withUserIds[i]);emails.push(user.Email)}var newUser=this._getUserById(userId);emails.push(newUser.Email);return emails};QorChatServerAdapter.prototype._getPrivateConvEmails=function(toUserId){var emails=new Array;var toUser=this._getUserById(toUserId);emails.push(this.currentUser.Email);emails.push(toUser.Email);return emails};QorChatServerAdapter.prototype._setCurrentUserAndUserList=function(email){var self=this;self.users=new Array;$.ajax(QorChatAdapterConstants.CHAT_SERVER_BASE_HTTP_URL+"/teams/theplant/users",{async:false,type:"get",headers:{Authorization:"Bearer "+self.qorchatToken},contentType:"application/json",dataType:"json",success:function(data){var i=0;while(i<data.length){var u=data[i];var cui=new ChatUserInfo;cui.Id=u.id;cui.RoomId=QorChatAdapterConstants.DEFAULT_ROOM_ID;cui.Name=u.name;cui.Email=u.email;cui.ProfilePictureUrl=u.avatar;cui.Status=0;self.users.push(cui);if(cui.Email==email){self.currentUser=cui}i++}}});return self.currentUser!=null};QorChatServerAdapter.prototype._addParticipantToMeeting=function(convId,newUserId){var self=this;var ids=new Array;ids.push(newUserId);var options=new AddParticipantOptions;options.convId=convId;options.participantIds=ids;$.ajax(QorChatAdapterConstants.CHAT_SERVER_BASE_HTTP_URL+"/teams/theplant/conversations/add_participants",{async:false,type:"post",headers:{Authorization:"Bearer "+self.qorchatToken},contentType:"application/json",data:JSON.stringify(options),dataType:"json",success:function(data){if(data.Success){var newUser=self._getUserById(newUserId);self._notifyUserAdded(convId,newUser.Email)}}})};QorChatServerAdapter.prototype._notifyUserAdded=function(convId,newUserEmail){var ntf=new QorChatNotificationOptions;ntf.convId=convId;ntf.inviter_email=this.currentUser.Email;var emails=new Array;emails.push(newUserEmail);ntf.new_added_user_emails=emails;var data=new QorChatNotifyDataPkg(ntf);var jsonStr=JSON.stringify(data);this.conn.send(jsonStr)};QorChatServerAdapter.prototype._getConvParticipants=function(convId){var users=new Array;var self=this;$.ajax(QorChatAdapterConstants.CHAT_SERVER_BASE_HTTP_URL+"/teams/theplant/conversations/"+convId,{async:false,type:"get",headers:{Authorization:"Bearer "+self.qorchatToken},contentType:"application/json",dataType:"json",success:function(data){users=self._getUsersByIds(data.participantIds)}});return users};QorChatServerAdapter.prototype._getConvByEmails=function(emails,useCache){var self=this;var convId="";var options=new QueryConvOptions;options.participantEmails=emails.sort();var emailsStr=options.participantEmails.join("-");var key="qorchat-conv-key-"+emailsStr;var id=window.localStorage.getItem(key);if(useCache&&id){convId=id;return convId}$.ajax(QorChatAdapterConstants.CHAT_SERVER_BASE_HTTP_URL+"/teams/theplant/conversations",{async:false,type:"post",data:JSON.stringify(options),headers:{Authorization:"Bearer "+self.qorchatToken},contentType:"application/json",dataType:"json",success:function(data){convId=data.id}});if(useCache){window.localStorage.setItem(key,convId)}return convId};QorChatServerAdapter.prototype._getChatHistory=function(convId){var self=this;var msgs=new Array;var url=QorChatAdapterConstants.CHAT_SERVER_BASE_HTTP_URL+"/teams/theplant/messages?convId="+convId+"&before=&limit=5";$.ajax(url,{async:false,type:"get",headers:{Authorization:"Bearer "+self.qorchatToken},contentType:"application/json",dataType:"json",success:function(data){if(!data){return}for(var i=0;i<data.length;i++){var msg=new ChatMessageInfo;msg.ConversationId=convId;msg.RoomId=QorChatAdapterConstants.DEFAULT_ROOM_ID;var generateGuidPart=function(){return((1+Math.random())*65536|0).toString(16).substring(1)};var clientGuid=generateGuidPart()+generateGuidPart()+"-"+generateGuidPart()+"-"+generateGuidPart()+"-"+generateGuidPart()+"-"+generateGuidPart()+generateGuidPart()+generateGuidPart();msg.ClientGuid=clientGuid;msg.UserFromId=data[i].fromUserId;msg.UserToId=self.currentUser.Id;msg.Message=data[i].content;msgs.unshift(msg)}}});return msgs};QorChatServerAdapter.prototype._getUserById=function(userId){for(var i=0;i<this.users.length;i++){if(this.users[i].Id.toString()==userId)return this.users[i]}throw"Could not find the given user"};QorChatServerAdapter.prototype._getUsersByIds=function(userIds){var users=new Array;for(var i=0;i<this.users.length;i++){if(userIds.indexOf(this.users[i].Id.toString())!=-1){users.push(this.users[i])}}return users};QorChatServerAdapter.prototype._getUserByEmail=function(email){for(var i=0;i<this.users.length;i++){if(this.users[i].Email==email)return this.users[i]}throw"Could not find the given user"};QorChatServerAdapter.prototype._getUserByEmails=function(emails){var users=new Array;for(var i=0;i<this.users.length;i++){if(emails.indexOf(this.users[i].Email)!=-1){users.push(this.users[i])}}return users};return QorChatServerAdapter}();var QorChatAdapter=function(){function QorChatAdapter(email){if(!email){email="athom@126.com"}this.email=email;this.qorchatToken=this.currentUserAccessToken();this.loadCurrentUserId()}QorChatAdapter.prototype.init=function(done){if(!this.currentUser){return}this.client=new QorChatClientAdapter;this.server=new QorChatServerAdapter(this.client,this.email,this.qorchatToken);done(this.currentUser.Id)};QorChatAdapter.prototype.loadCurrentUserId=function(){var userId=0;var self=this;$.ajax(QorChatAdapterConstants.CHAT_SERVER_BASE_HTTP_URL+"/users/my-account",{async:false,type:"get",headers:{Authorization:"Bearer "+self.qorchatToken},contentType:"application/json",dataType:"json",success:function(u){var user=new ChatUserInfo;user.Id=u.id;user.RoomId=QorChatAdapterConstants.DEFAULT_ROOM_ID;user.Name=u.name;user.Email=u.email;user.ProfilePictureUrl=u.avatar;user.Status=0;self.currentUser=user}})};QorChatAdapter.prototype.currentUserAccessToken=function(){var token="";var self=this;$.ajax(QorChatAdapterConstants.CHAT_SERVER_BASE_HTTP_URL+"/fetch_chat_token",{async:false,type:"get",data:{email:this.email},contentType:"application/json",dataType:"json",success:function(data){token=data}});return token};return QorChatAdapter}();var owl;(function(owl){"use strict";var jsEnvironment={hasDefineProperty:typeof Object.defineProperty==="function"&&function(){try{Object.defineProperty({},"x",{});return true}catch(e){return false}}(),hasDontEnumBug:function(){for(var p in{toString:1}){if(p==="toString"){return false}}return true}(),dontEnums:["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"]};function Clone(){}function clone(target){if(target!==null&&typeof target==="object"){Clone.prototype=target;return new Clone}else{return target}}owl.clone=clone;function isNativeTypeWrapper(object){return object instanceof Number||object instanceof String||object instanceof Boolean||object instanceof Date}function copy(target){if(target===null||typeof target!=="object"){return target}else{if(isNativeTypeWrapper(target)){return new target.constructor(target.valueOf())}else{var isPlainObject=!(target instanceof target.constructor)||target.constructor===Object;var c=isPlainObject?{}:clone(target.constructor.prototype);if(jsEnvironment.hasDefineProperty){Object.getOwnPropertyNames(target).forEach(function(property){Object.defineProperty(c,property,Object.getOwnPropertyDescriptor(target,property))})}else{for(var property in target){if(isPlainObject||Object.prototype.hasOwnProperty.call(target,property)){c[property]=target[property]}}if(jsEnvironment.hasDontEnumBug){for(var i=0;i<jsEnvironment.dontEnums.length;i++){property=jsEnvironment.dontEnums[i];if(Object.prototype.hasOwnProperty.call(target,property)){c[property]=target[property]}}}}return c}}}owl.copy=copy;function deepCopy(source,maxDepth){var deepCopyAlgorithm=new DeepCopyAlgorithm;if(maxDepth){deepCopyAlgorithm.maxDepth=maxDepth}return deepCopyAlgorithm.deepCopy(source)}owl.deepCopy=deepCopy;var deepCopy;(function(deepCopy){var DeepCopier=function(){function DeepCopier(config){for(var key in config){if(Object.prototype.hasOwnProperty.call(config,key)){this[key]=config[key]}}}DeepCopier.prototype.canCopy=function(source){return false};DeepCopier.prototype.create=function(source){};DeepCopier.prototype.populate=function(deepCopyAlgorithm,source,result){};return DeepCopier}();deepCopy.DeepCopier=DeepCopier;deepCopy.deepCopiers=[]})(deepCopy=owl.deepCopy||(owl.deepCopy={}));var DeepCopyAlgorithm=function(){function DeepCopyAlgorithm(){this.maxDepth=256;this.copiedObjects=[];var thisPass=this;this.recursiveDeepCopy=function(source){return thisPass.deepCopy(source)};this.depth=0}DeepCopyAlgorithm.prototype.cacheResult=function(source,result){this.copiedObjects.push([source,result])};DeepCopyAlgorithm.prototype.getCachedResult=function(source){var copiedObjects=this.copiedObjects;var length=copiedObjects.length;for(var i=0;i<length;i++){if(copiedObjects[i][0]===source){return copiedObjects[i][1]}}return undefined};DeepCopyAlgorithm.prototype.deepCopy=function(source){if(source===null){return null}if(typeof source!=="object"){return source}var cachedResult=this.getCachedResult(source);if(cachedResult){return cachedResult}for(var i=0;i<deepCopy.deepCopiers.length;i++){var deepCopier=deepCopy.deepCopiers[i];if(deepCopier.canCopy(source)){return this.applyDeepCopier(deepCopier,source)}}throw new Error("no DeepCopier is able to copy "+source)};DeepCopyAlgorithm.prototype.applyDeepCopier=function(deepCopier,source){var result=deepCopier.create(source);this.cacheResult(source,result);this.depth++;if(this.depth>this.maxDepth){throw new Error("Exceeded max recursion depth in deep copy.")}deepCopier.populate(this.recursiveDeepCopy,source,result);this.depth--;return result};return DeepCopyAlgorithm}();owl.DeepCopyAlgorithm=DeepCopyAlgorithm;var deepCopy;(function(deepCopy){function register(deepCopier){if(!(deepCopier instanceof deepCopy.DeepCopier)){deepCopier=new deepCopy.DeepCopier(deepCopier)}deepCopy.deepCopiers.unshift(deepCopier)}deepCopy.register=register})(deepCopy=owl.deepCopy||(owl.deepCopy={}));deepCopy.register({canCopy:function(source){return true},create:function(source){if(source instanceof source.constructor){return clone(source.constructor.prototype)}else{return{}}},populate:function(deepCopy,source,result){if(jsEnvironment.hasDefineProperty){Object.getOwnPropertyNames(source).forEach(function(key){var descriptor=Object.getOwnPropertyDescriptor(source,key);descriptor.value=deepCopy(descriptor.value);Object.defineProperty(result,key,descriptor)})}else{for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){result[key]=deepCopy(source[key])}}if(jsEnvironment.hasDontEnumBug){for(var i=0;i<jsEnvironment.dontEnums.length;i++){key=jsEnvironment.dontEnums[i];if(Object.prototype.hasOwnProperty.call(source,key)){result[key]=deepCopy(source[key])}}}}return result}});deepCopy.register({canCopy:function(source){return source instanceof Array},create:function(source){return new source.constructor},populate:function(deepCopy,source,result){for(var i=0;i<source.length;i++){result.push(deepCopy(source[i]))}return result}});deepCopy.register({canCopy:function(source){return isNativeTypeWrapper(source)},create:function(source){return new source.constructor(source.valueOf())}});function isNode(source){if(window["Node"]){return source instanceof Node}else{if(source===document){return true}return typeof source.nodeType==="number"&&source.attributes!==undefined&&source.childNodes&&source.cloneNode}}deepCopy.register({canCopy:function(source){return isNode(source)},create:function(source){if(source===document){return document}return source.cloneNode(false)},populate:function(deepCopy,source,result){if(source===document){return document}if(source.childNodes&&source.childNodes.length){for(var i=0;i<source.childNodes.length;i++){var childCopy=deepCopy(source.childNodes[i]);result.appendChild(childCopy)}}}})})(owl||(owl={}));